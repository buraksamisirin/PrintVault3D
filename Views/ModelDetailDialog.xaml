<Window x:Class="PrintVault3D.Views.ModelDetailDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:h="http://helix-toolkit.org/wpf"
        xmlns:converters="clr-namespace:PrintVault3D.Converters"
        mc:Ignorable="d"
        Title="Model Details"
        Height="650" Width="900"
        WindowStartupLocation="CenterOwner"
        ResizeMode="CanResize"
        Background="{StaticResource BackgroundDarkBrush}"
        WindowStyle="None"
        AllowsTransparency="True">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <converters:NullToVisibilityConverter x:Key="NullToVis"/>
        <converters:GcodeCostConverter x:Key="GcodeCostConverter"/>
    </Window.Resources>

    <Border BorderBrush="{StaticResource BorderBrush}" 
            BorderThickness="1" 
            CornerRadius="12"
            Background="{StaticResource BackgroundDarkBrush}">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Title Bar -->
            <Border Grid.Row="0" 
                    Background="{StaticResource BackgroundMediumBrush}"
                    CornerRadius="12,12,0,0"
                    Padding="20,16"
                    MouseLeftButtonDown="TitleBar_MouseLeftButtonDown">
                <Grid>
                    <StackPanel Orientation="Horizontal">
                        <Path Data="M12,2L2,7V17L12,22L22,17V7L12,2Z"
                              Fill="{StaticResource AccentCyanBrush}"
                              Width="24" Height="24"
                              Stretch="Uniform"
                              Margin="0,0,12,0"/>
                        <!-- Editable Model Name -->
                        <TextBox Text="{Binding ModelName, UpdateSourceTrigger=PropertyChanged}" 
                                 FontSize="18"
                                 FontWeight="SemiBold"
                                 Foreground="{StaticResource TextPrimaryBrush}"
                                 Background="Transparent"
                                 BorderThickness="0"
                                 VerticalAlignment="Center"
                                 MinWidth="150"
                                 MaxWidth="400"/>
                        <Border Background="{StaticResource BackgroundLightBrush}"
                                CornerRadius="4"
                                Padding="8,4"
                                Margin="12,0,0,0"
                                VerticalAlignment="Center">
                            <TextBlock Text="{Binding Model.FileType}"
                                       FontSize="11"
                                       FontWeight="Bold"
                                       Foreground="{StaticResource AccentCyanBrush}"/>
                        </Border>
                    </StackPanel>

                    <Button Style="{StaticResource IconButton}"
                            Command="{Binding CloseCommand}"
                            HorizontalAlignment="Right"
                            Width="32" Height="32">
                        <Path Data="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"
                              Fill="{StaticResource TextSecondaryBrush}"
                              Width="14" Height="14"
                              Stretch="Uniform"/>
                    </Button>
                </Grid>
            </Border>

            <!-- Content -->
            <Grid Grid.Row="1" Margin="24">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="300"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Left: 3D Preview -->
                <Border Grid.Column="0"
                        Background="{StaticResource BackgroundMediumBrush}"
                        CornerRadius="12"
                        Margin="0,0,16,0"
                        ClipToBounds="True">
                    <Grid>
                        <!-- 3D View - Camera fixed, model rotates -->
                        <h:HelixViewport3D x:Name="Viewport3D"
                                           ShowCoordinateSystem="False"
                                           IsRotationEnabled="False"
                                           IsPanEnabled="False"
                                           IsZoomEnabled="True"
                                           ZoomSensitivity="1"
                                           ModelUpDirection="0,0,1"
                                           MouseLeftButtonDown="Viewport3D_MouseLeftButtonDown"
                                           MouseLeftButtonUp="Viewport3D_MouseLeftButtonUp"
                                           MouseMove="Viewport3D_MouseMove">
                            <h:DefaultLights/>
                            <ModelVisual3D x:Name="ModelVisual">
                                <ModelVisual3D.Transform>
                                    <Transform3DGroup>
                                        <!-- Step 1: Move model to origin (center it) -->
                                        <TranslateTransform3D x:Name="TranslateToOrigin" OffsetX="0" OffsetY="0" OffsetZ="0"/>
                                        <!-- Step 2: Rotate around X axis (up/down drag) -->
                                        <RotateTransform3D>
                                            <RotateTransform3D.Rotation>
                                                <AxisAngleRotation3D x:Name="RotationX" Axis="1,0,0" Angle="0"/>
                                            </RotateTransform3D.Rotation>
                                        </RotateTransform3D>
                                        <!-- Step 3: Rotate around Z axis (left/right drag) -->
                                        <RotateTransform3D>
                                            <RotateTransform3D.Rotation>
                                                <AxisAngleRotation3D x:Name="RotationZ" Axis="0,0,1" Angle="0"/>
                                            </RotateTransform3D.Rotation>
                                        </RotateTransform3D>
                                        <!-- Step 4: Move model back to original position -->
                                        <TranslateTransform3D x:Name="TranslateBack" OffsetX="0" OffsetY="0" OffsetZ="0"/>
                                    </Transform3DGroup>
                                </ModelVisual3D.Transform>
                                <ModelVisual3D.Content>
                                    <GeometryModel3D Geometry="{Binding ModelGeometry}">
                                        <GeometryModel3D.Material>
                                            <MaterialGroup>
                                                <DiffuseMaterial>
                                                    <DiffuseMaterial.Brush>
                                                        <SolidColorBrush Color="#00B4D8" Opacity="0.8"/>
                                                    </DiffuseMaterial.Brush>
                                                </DiffuseMaterial>
                                                <SpecularMaterial SpecularPower="24">
                                                    <SpecularMaterial.Brush>
                                                        <SolidColorBrush Color="White"/>
                                                    </SpecularMaterial.Brush>
                                                </SpecularMaterial>
                                            </MaterialGroup>
                                        </GeometryModel3D.Material>
                                    </GeometryModel3D>
                                </ModelVisual3D.Content>
                            </ModelVisual3D>
                        </h:HelixViewport3D>

                        <!-- Loading Indicator -->
                        <Grid Visibility="{Binding IsLoading3D, Converter={StaticResource BoolToVis}}"
                              Background="#80000000">
                            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                                <Viewbox Width="40" Height="40">
                                    <Path Fill="{StaticResource AccentCyanBrush}"
                                          Data="M12,4V2A10,10 0 0,0 2,12H4A8,8 0 0,1 12,4Z"
                                          RenderTransformOrigin="0.5,0.5">
                                        <Path.Triggers>
                                            <EventTrigger RoutedEvent="Loaded">
                                                <BeginStoryboard>
                                                    <Storyboard>
                                                        <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(RotateTransform.Angle)"
                                                                         From="0" To="360" Duration="0:0:1"
                                                                         RepeatBehavior="Forever"/>
                                                    </Storyboard>
                                                </BeginStoryboard>
                                            </EventTrigger>
                                        </Path.Triggers>
                                        <Path.RenderTransform>
                                            <RotateTransform/>
                                        </Path.RenderTransform>
                                    </Path>
                                </Viewbox>
                                <TextBlock Text="Loading Model..."
                                           Foreground="White"
                                           Margin="0,12,0,0"
                                           FontSize="14"/>
                            </StackPanel>
                        </Grid>
     
                        <!-- Geometry Info Overlay -->
                        <Border VerticalAlignment="Top" HorizontalAlignment="Left" 
                                Background="#80000000" CornerRadius="4" Margin="10" Padding="8,4"
                                Visibility="{Binding ModelGeometry, Converter={StaticResource BoolToVis}}">
                            <TextBlock Text="{Binding GeometryInfo}" Foreground="White" FontSize="11" FontWeight="SemiBold"/>
                        </Border>

                        <!-- Reset View Button (Bottom Left) -->
                        <Button Style="{StaticResource IconButton}"
                                Click="ResetView_Click"
                                HorizontalAlignment="Left"
                                VerticalAlignment="Bottom"
                                Margin="12"
                                Width="36" Height="36"
                                ToolTip="Reset View">
                            <Path Data="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z"
                                  Fill="{StaticResource TextSecondaryBrush}"
                                  Width="18" Height="18"
                                  Stretch="Uniform"/>
                        </Button>

                        <!-- Favorite Button (Top Right) -->
                        <Button Style="{StaticResource IconButton}"
                                Command="{Binding ToggleFavoriteCommand}"
                                HorizontalAlignment="Right"
                                VerticalAlignment="Top"
                                Margin="12"
                                Width="40" Height="40">
                            <Path Width="20" Height="20" Stretch="Uniform">
                                <Path.Style>
                                    <Style TargetType="Path">
                                        <Setter Property="Data" Value="M12.1,18.55L12,18.65L11.89,18.55C7.14,14.24 4,11.39 4,8.5C4,6.5 5.5,5 7.5,5C9.04,5 10.54,6 11.07,7.36H12.93C13.46,6 14.96,5 16.5,5C18.5,5 20,6.5 20,8.5C20,11.39 16.86,14.24 12.1,18.55M16.5,3C14.76,3 13.09,3.81 12,5.08C10.91,3.81 9.24,3 7.5,3C4.42,3 2,5.41 2,8.5C2,12.27 5.4,15.36 10.55,20.03L12,21.35L13.45,20.03C18.6,15.36 22,12.27 22,8.5C22,5.41 19.58,3 16.5,3Z"/>
                                        <Setter Property="Fill" Value="{StaticResource TextMutedBrush}"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Model.IsFavorite}" Value="True">
                                                <Setter Property="Data" Value="M12,21.35L10.55,20.03C5.4,15.36 2,12.27 2,8.5C2,5.41 4.42,3 7.5,3C9.24,3 10.91,3.81 12,5.08C13.09,3.81 14.76,3 16.5,3C19.58,3 22,5.41 22,8.5C22,12.27 18.6,15.36 13.45,20.03L12,21.35Z"/>
                                                <Setter Property="Fill" Value="{StaticResource AccentRedBrush}"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Path.Style>
                            </Path>
                        </Button>
                    </Grid>
                </Border>

                <!-- Right: Details -->
                <ScrollViewer Grid.Column="1" VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <!-- File Info -->
                        <TextBlock Text="FILE INFO" 
                                   Style="{StaticResource CaptionText}"
                                   FontWeight="SemiBold"
                                   Margin="0,0,0,12"/>

                        <Grid Margin="0,0,0,16">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <Border Grid.Row="0" Grid.Column="0" Style="{StaticResource StatCard}" Margin="0,0,8,8">
                                <StackPanel>
                                    <TextBlock Text="File Size" Style="{StaticResource CaptionText}"/>
                                    <TextBlock Text="{Binding FileSizeFormatted}" 
                                               FontSize="18" FontWeight="SemiBold"
                                               Foreground="{StaticResource AccentCyanBrush}"/>
                                </StackPanel>
                            </Border>

                            <Border Grid.Row="0" Grid.Column="1" Style="{StaticResource StatCard}" Margin="8,0,0,8">
                                <StackPanel>
                                    <TextBlock Text="Date Added" Style="{StaticResource CaptionText}"/>
                                    <TextBlock Text="{Binding Model.AddedDate, StringFormat={}{0:dd MMM yyyy}}" 
                                               FontSize="18" FontWeight="SemiBold"/>
                                </StackPanel>
                            </Border>

                            <Border Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" Style="{StaticResource StatCard}" Margin="0,0,0,8">
                                <StackPanel>
                                    <TextBlock Text="File Path" Style="{StaticResource CaptionText}"/>
                                    <TextBlock Text="{Binding Model.FilePath}" 
                                               TextTrimming="CharacterEllipsis"
                                               ToolTip="{Binding Model.FilePath}"
                                               Foreground="{StaticResource TextSecondaryBrush}"/>
                                </StackPanel>
                            </Border>

                            <Border Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2" Style="{StaticResource StatCard}">
                                <StackPanel>
                                    <TextBlock Text="Source URL" Style="{StaticResource CaptionText}"/>
                                    <Grid Margin="0,4,0,0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBox Grid.Column="0"
                                                 Text="{Binding SourceUrl, UpdateSourceTrigger=PropertyChanged}"
                                                 Style="{StaticResource SearchTextBox}"
                                                 VerticalAlignment="Center"/>
                                        <Button Grid.Column="1"
                                                Style="{StaticResource IconButton}"
                                                Command="{Binding OpenSourceUrlCommand}"
                                                ToolTip="Open URL in browser"
                                                Margin="8,0,0,0"
                                                Width="32" Height="32"
                                                Visibility="{Binding HasSourceUrl, Converter={StaticResource BoolToVis}}">
                                            <Path Data="M14,3V5H17.59L7.76,14.83L9.17,16.24L19,6.41V10H21V3M19,19H5V5H12V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V12H19V19Z"
                                                  Fill="{StaticResource AccentBlueBrush}"
                                                  Width="14" Height="14"
                                                  Stretch="Uniform"/>
                                        </Button>
                                    </Grid>
                                </StackPanel>
                            </Border>

                        </Grid>

                        <!-- Category -->
                        <TextBlock Text="CATEGORY" 
                                   Style="{StaticResource CaptionText}"
                                   FontWeight="SemiBold"
                                   Margin="0,8,0,8"/>
                        
                        <ComboBox ItemsSource="{Binding Categories}"
                                  SelectedItem="{Binding SelectedCategory}"
                                  Padding="12,10"
                                  Margin="0,0,0,16"
                                  Style="{StaticResource DarkComboBox}">
                            <ComboBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Name}"/>
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>

                        <!-- Tags -->
                        <TextBlock Text="TAGS (comma separated)" 
                                   Style="{StaticResource CaptionText}"
                                   FontWeight="SemiBold"
                                   Margin="0,0,0,8"/>
                        
                        <TextBox x:Name="TagsTextBox"
                                 Text="{Binding Tags, UpdateSourceTrigger=PropertyChanged}"
                                 Style="{StaticResource SearchTextBox}"
                                 Margin="0,0,0,8"/>
                        
                        <!-- Tag Suggestions -->
                        <ItemsControl ItemsSource="{Binding TagSuggestions}" Margin="0,0,0,16">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Button Content="{Binding}"
                                            Click="TagSuggestion_Click"
                                            Tag="{Binding}"
                                            Margin="0,0,6,6"
                                            Padding="10,5"
                                            FontSize="11"
                                            Cursor="Hand">
                                        <Button.Style>
                                            <Style TargetType="Button">
                                                <Setter Property="Background" Value="{StaticResource BackgroundLightBrush}"/>
                                                <Setter Property="Foreground" Value="{StaticResource TextSecondaryBrush}"/>
                                                <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}"/>
                                                <Setter Property="BorderThickness" Value="1"/>
                                                <Setter Property="Template">
                                                    <Setter.Value>
                                                        <ControlTemplate TargetType="Button">
                                                            <Border Background="{TemplateBinding Background}"
                                                                    BorderBrush="{TemplateBinding BorderBrush}"
                                                                    BorderThickness="{TemplateBinding BorderThickness}"
                                                                    CornerRadius="12"
                                                                    Padding="{TemplateBinding Padding}">
                                                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                            </Border>
                                                        </ControlTemplate>
                                                    </Setter.Value>
                                                </Setter>
                                                <Style.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Background" Value="{StaticResource AccentCyanBrush}"/>
                                                        <Setter Property="Foreground" Value="White"/>
                                                    </Trigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Button.Style>
                                    </Button>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <!-- Notes -->
                        <TextBlock Text="NOTES" 
                                   Style="{StaticResource CaptionText}"
                                   FontWeight="SemiBold"
                                   Margin="0,0,0,8"/>
                        
                        <TextBox Text="{Binding Notes, UpdateSourceTrigger=PropertyChanged}"
                                 Style="{StaticResource SearchTextBox}"
                                 AcceptsReturn="True"
                                 TextWrapping="Wrap"
                                 Height="100"
                                 VerticalContentAlignment="Top"
                                 Margin="0,0,0,16"/>

                        <!-- G-codes -->
                        <!-- G-codes -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                            <TextBlock Text="LINKED G-CODES" 
                                       Style="{StaticResource CaptionText}"
                                       FontWeight="SemiBold"
                                       VerticalAlignment="Center"
                                       Margin="0,0,12,0"/>
                            <Button Content="+ Link G-code"
                                    Click="LinkGcode_Click"
                                    FontSize="10"
                                    Padding="8,2"
                                    Height="20"
                                    Cursor="Hand">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource SecondaryButton}">
                                        <Setter Property="Background" Value="Transparent"/>
                                        <Setter Property="BorderThickness" Value="1"/>
                                    </Style>
                                </Button.Style>
                            </Button>
                        </StackPanel>

                        <ItemsControl ItemsSource="{Binding Gcodes}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Style="{StaticResource StatCard}" Margin="0,0,0,8" Padding="0"
                                            Tag="{Binding DataContext, RelativeSource={RelativeSource AncestorType=Window}}">
                                        <!-- Original ContextMenu removed, now on Button -->
                                        
                                        <Expander Background="Transparent" BorderThickness="0" Padding="12">
                                            <Expander.Header>
                                                <Grid Width="460"> <!-- Fixed width to ensure stretching -->
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>
                                                    
                                                    <StackPanel Grid.Column="0">
                                                        <TextBlock Text="{Binding OriginalFileName}" FontWeight="Medium" TextTrimming="CharacterEllipsis"/>
                                                        <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                                                            <TextBlock Text="{Binding PrintTimeFormatted, StringFormat='⏱ {0}'}" 
                                                                       Style="{StaticResource CaptionText}"
                                                                       Margin="0,0,12,0"
                                                                       Visibility="{Binding PrintTime, Converter={StaticResource NullToVis}}"/>
                                                            
                                                            <TextBlock Text="{Binding FilamentWeight, StringFormat='🧵 {0:0.#}g'}" 
                                                                       Style="{StaticResource CaptionText}"
                                                                       Margin="0,0,12,0"
                                                                       Visibility="{Binding FilamentWeight, Converter={StaticResource NullToVis}}"/>
                                                            
                                                            <!-- Cost Display -->
                                                            <TextBlock Style="{StaticResource CaptionText}" Foreground="{StaticResource AccentGreenBrush}">
                                                                <TextBlock.Text>
                                                                    <MultiBinding Converter="{StaticResource GcodeCostConverter}">
                                                                        <Binding Path="."/>
                                                                        <Binding Path="DataContext.FilamentCostPerKg" RelativeSource="{RelativeSource AncestorType=Window}"/>
                                                                    </MultiBinding>
                                                                </TextBlock.Text>
                                                            </TextBlock>
                                                        </StackPanel>
                                                    </StackPanel>
                                                    
                                                    <StackPanel Grid.Column="1" VerticalAlignment="Center" Orientation="Horizontal">
                                                        <TextBlock Text="{Binding SlicerName}" 
                                                                   Style="{StaticResource CaptionText}"
                                                                   VerticalAlignment="Center"
                                                                   Margin="0,0,8,0"/>
                                                        
                                                        <!-- Context Menu Button -->
                                                        <Button Style="{StaticResource IconButton}"
                                                                Click="GcodeOptionButton_Click"
                                                                Tag="{Binding DataContext, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                Width="24" Height="24">
                                                            <Button.ContextMenu>
                                                                <ContextMenu>
                                                                    <MenuItem Header="Uygulamada Aç" 
                                                                              Command="{Binding PlacementTarget.Tag.OpenGcodeFileCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" 
                                                                              CommandParameter="{Binding}"/>
                                                                    <MenuItem Header="Klasörde Göster" 
                                                                              Command="{Binding PlacementTarget.Tag.OpenGcodeFolderCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" 
                                                                              CommandParameter="{Binding}"/>
                                                                    <MenuItem Header="Bilgileri Güncelle" 
                                                                              Command="{Binding PlacementTarget.Tag.RefreshGcodeMetadataCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" 
                                                                              CommandParameter="{Binding}"/>
                                                                    <Separator/>
                                                                    <MenuItem Header="Yolu Kopyala" 
                                                                              Command="{Binding PlacementTarget.Tag.CopyGcodePathCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" 
                                                                              CommandParameter="{Binding}"/>
                                                                    <MenuItem Header="Bağlantıyı Kaldır" 
                                                                              Command="{Binding PlacementTarget.Tag.UnlinkGcodeCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" 
                                                                              CommandParameter="{Binding}" 
                                                                              Foreground="#FF5252"/>
                                                                </ContextMenu>
                                                            </Button.ContextMenu>
                                                            <Path Data="M12,16A2,2 0 0,1 14,18A2,2 0 0,1 12,20A2,2 0 0,1 10,18A2,2 0 0,1 12,16M12,10A2,2 0 0,1 14,12A2,2 0 0,1 12,14A2,2 0 0,1 10,12A2,2 0 0,1 12,10M12,4A2,2 0 0,1 14,6A2,2 0 0,1 12,8A2,2 0 0,1 10,6A2,2 0 0,1 12,4Z"
                                                                  Fill="{StaticResource TextMutedBrush}"
                                                                  Width="4" Height="16"
                                                                  Stretch="Uniform"/>
                                                        </Button>
                                                    </StackPanel>
                                                </Grid>
                                            </Expander.Header>
                                            
                                            <!-- Expanded Details -->
                                            <StackPanel Margin="0,8,0,0">
                                                <!-- Technical Details -->
                                                <UniformGrid Columns="2" Margin="0,0,0,12">
                                                    <StackPanel Margin="0,0,8,8" Visibility="{Binding LayerHeight, Converter={StaticResource NullToVis}}">
                                                        <TextBlock Text="Layer Height" Style="{StaticResource CaptionText}"/>
                                                        <TextBlock Text="{Binding LayerHeight, StringFormat='{}{0} mm'}" Foreground="{StaticResource TextPrimaryBrush}"/>
                                                    </StackPanel>
                                                    <StackPanel Margin="0,0,0,8" Visibility="{Binding InfillPercentage, Converter={StaticResource NullToVis}}">
                                                        <TextBlock Text="Infill" Style="{StaticResource CaptionText}"/>
                                                        <TextBlock Text="{Binding InfillPercentage, StringFormat='{}{0}%'}" Foreground="{StaticResource TextPrimaryBrush}"/>
                                                    </StackPanel>
                                                    <StackPanel Margin="0,0,8,0" Visibility="{Binding NozzleTemp, Converter={StaticResource NullToVis}}">
                                                        <TextBlock Text="Nozzle Temp" Style="{StaticResource CaptionText}"/>
                                                        <TextBlock Text="{Binding NozzleTemp, StringFormat='{}{0}°C'}" Foreground="{StaticResource TextPrimaryBrush}"/>
                                                    </StackPanel>
                                                    <StackPanel Visibility="{Binding BedTemp, Converter={StaticResource NullToVis}}">
                                                        <TextBlock Text="Bed Temp" Style="{StaticResource CaptionText}"/>
                                                        <TextBlock Text="{Binding BedTemp, StringFormat='{}{0}°C'}" Foreground="{StaticResource TextPrimaryBrush}"/>
                                                    </StackPanel>
                                                </UniformGrid>

                                                <!-- Separator -->
                                                <Border Background="{StaticResource BorderBrush}" Height="1" Margin="0,4,0,12"/>

                                                <!-- Print Log & Notes Section -->
                                                <Grid>
                                                    <Grid.RowDefinitions>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="Auto"/>
                                                    </Grid.RowDefinitions>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>

                                                    <!-- Status -->
                                                    <StackPanel Grid.Row="0" Grid.Column="0" Margin="0,0,8,8">
                                                        <TextBlock Text="Print Status" Style="{StaticResource CaptionText}"/>
                                                        <ComboBox ItemsSource="{Binding DataContext.PrintStatusOptions, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                  SelectedItem="{Binding PrintStatus}"
                                                                  Style="{StaticResource DarkComboBox}"
                                                                  Padding="8,4" FontSize="11"/>
                                                    </StackPanel>

                                                    <!-- Rating -->
                                                    <StackPanel Grid.Row="0" Grid.Column="1" Margin="0,0,8,8">
                                                        <TextBlock Text="Rating (1-5)" Style="{StaticResource CaptionText}"/>
                                                        <ComboBox ItemsSource="{Binding DataContext.RatingOptions, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                  SelectedItem="{Binding Rating}"
                                                                  Style="{StaticResource DarkComboBox}"
                                                                  Padding="8,4" FontSize="11"/>
                                                    </StackPanel>

                                                    <!-- Save Button (Log) -->
                                                    <Button Grid.Row="0" Grid.Column="2"
                                                            Style="{StaticResource IconButton}"
                                                            Command="{Binding DataContext.SaveGcodeCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                            CommandParameter="{Binding}"
                                                            VerticalAlignment="Bottom"
                                                            Margin="0,0,0,8"
                                                            ToolTip="Save Print Log">
                                                        <Path Data="M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z"
                                                              Fill="{StaticResource AccentCyanBrush}"
                                                              Width="16" Height="16"
                                                              Stretch="Uniform"/>
                                                    </Button>

                                                    <!-- Notes -->
                                                    <StackPanel Grid.Row="1" Grid.ColumnSpan="3">
                                                        <TextBlock Text="G-code Notes" Style="{StaticResource CaptionText}"/>
                                                        <TextBox Text="{Binding Notes, UpdateSourceTrigger=PropertyChanged}"
                                                                 Style="{StaticResource InputTextBox}"
                                                                 Tag="Add notes here..."
                                                                 Height="60"
                                                                 AcceptsReturn="True"
                                                                 TextWrapping="Wrap"
                                                                 FontSize="11"
                                                                 Padding="8"/>
                                                    </StackPanel>
                                                </Grid>
                                            </StackPanel>
                                        </Expander>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <TextBlock Text="No linked G-codes yet"
                                   Opacity="0.5">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock" BasedOn="{StaticResource CaptionText}">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding Gcodes.Count}" Value="0">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </StackPanel>
                </ScrollViewer>
            </Grid>

            <!-- Footer -->
            <Border Grid.Row="2"
                    Background="{StaticResource BackgroundMediumBrush}"
                    CornerRadius="0,0,12,12"
                    Padding="24,16">
                <Grid>
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Left">
                        <Button Style="{StaticResource SecondaryButton}"
                                Command="{Binding OpenFileLocationCommand}"
                                Margin="0,0,12,0">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="M10,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8C22,6.89 21.1,6 20,6H12L10,4Z"
                                      Fill="{StaticResource TextSecondaryBrush}"
                                      Width="14" Height="14"
                                      Stretch="Uniform"
                                      Margin="0,0,8,0"/>
                                <TextBlock Text="Show in Folder"/>
                            </StackPanel>
                        </Button>

                        <Button Style="{StaticResource SecondaryButton}"
                                Command="{Binding OpenInDefaultAppCommand}">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="M14,3V5H17.59L7.76,14.83L9.17,16.24L19,6.41V10H21V3M19,19H5V5H12V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V12H19V19Z"
                                      Fill="{StaticResource TextSecondaryBrush}"
                                      Width="14" Height="14"
                                      Stretch="Uniform"
                                      Margin="0,0,8,0"/>
                                <TextBlock Text="Open in App"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>

                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button Style="{StaticResource SecondaryButton}"
                                Command="{Binding CloseCommand}"
                                Content="Cancel"
                                Margin="0,0,12,0"/>
                        <Button Style="{StaticResource PrimaryButton}"
                                Command="{Binding SaveChangesCommand}"
                                Content="Save"/>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>
    </Border>
</Window>


