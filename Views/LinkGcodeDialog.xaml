<Window x:Class="PrintVault3D.Views.LinkGcodeDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:converters="clr-namespace:PrintVault3D.Converters"
        mc:Ignorable="d"
        Title="Link G-code" Height="500" Width="600"
        WindowStartupLocation="CenterOwner"
        WindowStyle="ToolWindow"
        ResizeMode="NoResize"
        Background="{StaticResource BackgroundDarkBrush}">

    <Window.Resources>
        <converters:BytesToHumanReadableConverter x:Key="BytesToSize"/>
        <converters:TicksToTimeConverter x:Key="TicksToTime"/>
    </Window.Resources>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="0,0,0,20">
            <TextBlock Text="Link Existing G-code" Style="{StaticResource HeaderText}"/>
            <TextBlock Text="Select a G-code file effectively to link to this model." 
                       Style="{StaticResource CaptionText}"
                       Margin="0,5,0,0"/>
        </StackPanel>

        <!-- Search -->
        <Border Grid.Row="1" Background="{StaticResource BackgroundLightBrush}" 
                CornerRadius="8" Padding="10" Margin="0,0,0,15">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <Path Data="M15.5,14L14.71,13.21C15.55,12.11 16,10.73 16,9.25C16,5.5 13,2.5 9.25,2.5C5.5,2.5 2.5,5.5 2.5,9.25C2.5,13 5.5,16 9.25,16C10.73,16 12.11,15.55 13.21,14.71L14,15.5V16.25L19,21.25L20.5,19.75L15.5,14.75V14M9.25,14C6.63,14 4.5,11.87 4.5,9.25C4.5,6.63 6.63,4.5 9.25,4.5C11.87,4.5 14,6.63 14,9.25C14,11.87 11.87,14 9.25,14Z" 
                      Fill="{StaticResource TextSecondaryBrush}" Stretch="Uniform" Width="16" Height="16" Margin="0,0,10,0"/>
                <TextBox Grid.Column="1" x:Name="SearchBox" 
                         Background="Transparent" BorderThickness="0" 
                         Foreground="{StaticResource TextPrimaryBrush}"
                         VerticalContentAlignment="Center"
                         TextChanged="SearchBox_TextChanged"
                         Tag="Search unlinked G-codes..."/>
            </Grid>
        </Border>

        <!-- List -->
        <ListBox Grid.Row="2" x:Name="GcodesList" 
                 Background="{StaticResource BackgroundLightBrush}"
                 BorderBrush="{StaticResource BorderBrush}"
                 BorderThickness="1"
                 ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                 SelectionMode="Single"
                 SelectionChanged="GcodesList_SelectionChanged">
            <ListBox.ItemContainerStyle>
                <Style TargetType="ListBoxItem">
                    <Setter Property="Padding" Value="10"/>
                    <Setter Property="Margin" Value="0,0,0,4"/>
                    <Setter Property="Background" Value="Transparent"/>
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="ListBoxItem">
                                <Border Background="{TemplateBinding Background}" 
                                        CornerRadius="6" 
                                        Padding="{TemplateBinding Padding}">
                                    <ContentPresenter/>
                                </Border>
                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="{StaticResource BackgroundMediumBrush}"/>
                                    </Trigger>
                                    <Trigger Property="IsSelected" Value="True">
                                        <Setter Property="Background" Value="{StaticResource AccentCyanBrush}"/>
                                        <Setter Property="Foreground" Value="Black"/>
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Style>
            </ListBox.ItemContainerStyle>
            <ListBox.ItemTemplate>
                <DataTemplate>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        
                        <StackPanel Grid.Column="0">
                            <TextBlock Text="{Binding OriginalFileName}" FontWeight="SemiBold" TextTrimming="CharacterEllipsis"/>
                            <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                                <TextBlock Text="{Binding FileSize, Converter={StaticResource BytesToSize}}" 
                                           FontSize="11" Opacity="0.7"/>
                                <TextBlock Text=" • " FontSize="11" Opacity="0.5"/>
                                <TextBlock Text="{Binding PrintTimeTicks, Converter={StaticResource TicksToTime}}" 
                                           FontSize="11" Opacity="0.7"/>
                            </StackPanel>
                        </StackPanel>
                        
                        <Border Grid.Column="1" Background="{StaticResource BackgroundDarkBrush}" 
                                CornerRadius="4" Padding="6,2" VerticalAlignment="Center" Margin="10,0,0,0">
                            <TextBlock Text="{Binding AddedDate, StringFormat=d}" FontSize="10" 
                                       Foreground="{StaticResource TextSecondaryBrush}"/>
                        </Border>
                    </Grid>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>

        <!-- Footer -->
        <StackPanel Grid.Row="3" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,20,0,0">
            <Button Content="Cancel" Style="{StaticResource SecondaryButton}" 
                    Click="CancelButton_Click" Margin="0,0,10,0"/>
            <Button x:Name="LinkButton" Content="Link G-code" Style="{StaticResource PrimaryButton}" 
                    Click="LinkButton_Click" IsEnabled="False"/>
        </StackPanel>
    </Grid>
</Window>

