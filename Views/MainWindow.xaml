<Window x:Class="PrintVault3D.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:PrintVault3D.ViewModels"
        xmlns:views="clr-namespace:PrintVault3D.Views"
        xmlns:converters="clr-namespace:PrintVault3D.Converters"
        xmlns:helpers="clr-namespace:PrintVault3D.Helpers"
        mc:Ignorable="d"
        Title="STLZ"
        Height="800" Width="1400"
        MinHeight="600" MinWidth="1000"
        WindowStartupLocation="CenterScreen"
        Style="{StaticResource MainWindowStyle}"
        AllowDrop="True"
        Drop="Window_Drop"
        DragEnter="Window_DragEnter"
        DragLeave="Window_DragLeave"
    DragOver="Window_DragOver"
    WindowStyle="None"
    AllowsTransparency="False"
    ResizeMode="CanResizeWithGrip">

    <Window.InputBindings>
        <KeyBinding Key="Z" Modifiers="Control" Command="{Binding UndoCommand}"/>
        <KeyBinding Key="Y" Modifiers="Control" Command="{Binding RedoCommand}"/>
        <KeyBinding Key="Z" Modifiers="Control+Shift" Command="{Binding RedoCommand}"/>
    </Window.InputBindings>

    <WindowChrome.WindowChrome>
        <WindowChrome CaptionHeight="32"  
                      GlassFrameThickness="0" 
                      CornerRadius="0" 
                      ResizeBorderThickness="4"/>
    </WindowChrome.WindowChrome>

    <Window.Resources>
        <!-- Converters -->
        <converters:BoolToVisibilityConverter x:Key="BoolToVis"/>
        <converters:SelectionToVisibilityConverter x:Key="SelectionToVis"/>
        <converters:IsSelectedConverter x:Key="IsSelected"/>
        <converters:CategoryColorConverter x:Key="CategoryColor"/>
        <converters:EqualityConverter x:Key="EqualityConverter"/>
        <converters:NullToVisibilityConverter x:Key="NullToVisConverter"/>
        <converters:HexColorToBrushConverter x:Key="HexToBrush"/>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Custom Title Bar -->
        <Grid Grid.Row="0" Height="32" Background="{StaticResource BackgroundMediumBrush}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- Branding -->
            <StackPanel Grid.Column="0" Orientation="Horizontal" Margin="12,0" VerticalAlignment="Center" IsHitTestVisible="False">
                <TextBlock Text="STLZ" FontWeight="Bold" FontSize="14" Foreground="{StaticResource AccentCyanBrush}" VerticalAlignment="Center"/>
                <TextBlock Text=" | LIBRARY" FontSize="12" Foreground="{StaticResource TextSecondaryBrush}" VerticalAlignment="Center" Margin="8,0,0,0"/>
            </StackPanel>

            <!-- Window Controls -->
            <StackPanel Grid.Column="2" Orientation="Horizontal">
                <Button Style="{StaticResource WindowControlButtonStyle}" Click="MinimizeButton_Click">
                    <Path Data="M0,8 L10,8 M0,9 L10,9" Stroke="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" StrokeThickness="1" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                </Button>
                <Button x:Name="MaximizeButton" Style="{StaticResource WindowControlButtonStyle}" Click="MaximizeButton_Click">
                    <Path Data="M2,2 L8,2 L8,8 L2,8 Z" Stroke="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" StrokeThickness="1" Fill="Transparent"/>
                </Button>
                <Button Style="{StaticResource WindowCloseButtonStyle}" Click="CloseButton_Click">
                    <Path Data="M2,2 L8,8 M8,2 L2,8" Stroke="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" StrokeThickness="1.5"/>
                </Button>
            </StackPanel>
        </Grid>

        <!-- Main Content -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
            <!-- Sidebar -->
            <ColumnDefinition Width="260"/>
            <!-- Main Content -->
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- ═══════════════════════════════════════════════════════════════════════════
             SIDEBAR
             ═══════════════════════════════════════════════════════════════════════════ -->
        <!-- ═══════════════════════════════════════════════════════════════════════════
             SIDEBAR
             ═══════════════════════════════════════════════════════════════════════════ -->
        <views:SidebarView Grid.Column="0"/>

        <!-- ═══════════════════════════════════════════════════════════════════════════
             MAIN CONTENT
             ═══════════════════════════════════════════════════════════════════════════ -->
        <Grid Grid.Column="1">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Header -->
            <Border Grid.Row="0" Padding="32,24">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0">
                        <StackPanel Orientation="Horizontal">
                            <!-- Category name (hidden when collection is selected) -->
                            <TextBlock Text="{Binding SelectedCategory.Name, FallbackValue='All Models'}"
                                       Style="{StaticResource HeaderText}"
                                       Visibility="{Binding SelectedCollection, Converter={StaticResource NullToVisConverter}}"/>
                            
                            <!-- Collection icon and name when selected -->
                            <Path Data="M3,3H21V21H3V3M5,5V19H19V5H5M7,7H11V11H7V7M13,7H17V11H13V7M7,13H11V17H7V13M13,13H17V17H13V13Z"
                                  Fill="{StaticResource AccentCyanBrush}"
                                  Width="24" Height="24"
                                  Stretch="Uniform"
                                  Margin="0,0,12,0"
                                  VerticalAlignment="Center"
                                  Visibility="{Binding SelectedCollection, Converter={StaticResource NullToVisConverter}, ConverterParameter=Inverse}"/>
                            <TextBlock Text="{Binding SelectedCollection.Name}"
                                       Style="{StaticResource HeaderText}"
                                       Foreground="{StaticResource AccentCyanBrush}"
                                       Visibility="{Binding SelectedCollection, Converter={StaticResource NullToVisConverter}, ConverterParameter=Inverse}"/>
                            
                            <!-- Clear filter button -->
                            <Button Style="{StaticResource IconButton}"
                                    Width="28" Height="28"
                                    Margin="12,0,0,0"
                                    ToolTip="Clear collection filter"
                                    Command="{Binding ClearSelectedCollectionCommand}"
                                    Visibility="{Binding SelectedCollection, Converter={StaticResource NullToVisConverter}, ConverterParameter=Inverse}">
                                <Path Data="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"
                                      Fill="{StaticResource TextSecondaryBrush}"
                                      Width="12" Height="12"
                                      Stretch="Uniform"/>
                            </Button>
                        </StackPanel>
                        <TextBlock Style="{StaticResource CaptionText}" Margin="0,4,0,0">
                            <Run Text="{Binding Models.Count, Mode=OneWay}"/>
                            <Run Text="items"/>
                        </TextBlock>
                    </StackPanel>

                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                        <Button Style="{StaticResource PrimaryButton}"
                                Command="{Binding ScanDownloadsFolderCommand}"
                                Margin="0,0,12,0"
                                ToolTip="Scan Downloads folder for STL/3MF files">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="M9,13A3,3 0 0,0 12,16A3,3 0 0,0 15,13A3,3 0 0,0 12,10A3,3 0 0,0 9,13M20,19.59V8L14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18C18.45,22 18.85,21.85 19.19,21.6L14.76,17.17C13.96,17.69 13,18 12,18A5,5 0 0,1 7,13A5,5 0 0,1 12,8A5,5 0 0,1 17,13C17,14 16.69,14.96 16.17,15.75L20,19.59Z"
                                      Fill="{StaticResource BackgroundDarkBrush}"
                                      Width="16" Height="16"
                                      Stretch="Uniform"
                                      Margin="0,0,8,0"/>
                                <TextBlock Text="Scan Downloads"/>
                            </StackPanel>
                        </Button>

                        <Button Style="{StaticResource SecondaryButton}"
                                Command="{Binding RefreshModelsCommand}"
                                Margin="0,0,12,0">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="M17.65,6.35A7.958,7.958 0 0,0 12,4C7.58,4 4,7.58 4,12C4,16.42 7.58,20 12,20C15.73,20 18.84,17.45 19.73,14H17.65A6,6 0 0,1 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z"
                                      Fill="{StaticResource TextSecondaryBrush}"
                                      Width="16" Height="16"
                                      Stretch="Uniform"
                                      Margin="0,0,8,0"/>
                                <TextBlock Text="Refresh"/>
                            </StackPanel>
                        </Button>

                        <Button Style="{StaticResource SecondaryButton}"
                                Command="{Binding ImportFilesManuallyCommand}"
                                ToolTip="Manually import files"
                                Margin="0,0,12,0">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"
                                      Fill="{StaticResource TextSecondaryBrush}"
                                      Width="16" Height="16"
                                      Stretch="Uniform"
                                      Margin="0,0,8,0"/>
                                <TextBlock Text="Import"/>
                            </StackPanel>
                        </Button>

                        <Button Style="{StaticResource SecondaryButton}"
                                Click="ManageGcodes_Click"
                                ToolTip="Manage all G-code files">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M13.5,13L15,11.5L19,15.5L17.5,17L13.5,13M6,8V6H16V8H6M6,12V10H13V12H6M6,16V14H9V16H6Z"
                                      Fill="{StaticResource AccentOrangeBrush}"
                                      Width="16" Height="16"
                                      Stretch="Uniform"
                                      Margin="0,0,8,0"/>
                                <TextBlock Text="G-codes"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>



            <!-- Models Grid -->
            <Grid Grid.Row="2">
                <ScrollViewer VerticalScrollBarVisibility="Auto"
                              Padding="24,0"
                              VirtualizingPanel.IsVirtualizing="True"
                              VirtualizingPanel.VirtualizationMode="Recycling"
                              VirtualizingPanel.ScrollUnit="Pixel">
                    <ItemsControl ItemsSource="{Binding Models}"
                                  VirtualizingPanel.IsVirtualizing="True"
                                  VirtualizingPanel.VirtualizationMode="Recycling">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <!-- WrapPanel doesn't support virtualization natively, but with pagination (50 items/page) this is manageable -->
                                <WrapPanel/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Style="{StaticResource ModelCard}" 
                                        Width="240" 
                                        Margin="8"
                                        Cursor="Hand"
                                        MouseLeftButtonDown="ModelCard_MouseLeftButtonDown"
                                        MouseMove="ModelCard_MouseMove"
                                        Tag="{Binding}">
                                    <Border.ContextMenu>
                                        <ContextMenu Background="{StaticResource BackgroundMediumBrush}"
                                                     BorderBrush="{StaticResource BorderBrush}"
                                                     Foreground="{StaticResource TextPrimaryBrush}">
                                            <MenuItem Header="Show Details"
                                                      Click="OpenModelDetail_Click"
                                                      Tag="{Binding}">
                                                <MenuItem.Icon>
                                                    <Path Data="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z"
                                                          Fill="{StaticResource TextSecondaryBrush}"
                                                          Width="14" Height="14"
                                                          Stretch="Uniform"/>
                                                </MenuItem.Icon>
                                            </MenuItem>
                                            <MenuItem Header="{Binding IsFavorite, Converter={StaticResource BoolToVis}, ConverterParameter=FavoriteText}"
                                                      Click="ToggleFavorite_Click"
                                                      Tag="{Binding}">
                                                <MenuItem.Style>
                                                    <Style TargetType="MenuItem">
                                                        <Setter Property="Header" Value="Add to Favorites"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding IsFavorite}" Value="True">
                                                                <Setter Property="Header" Value="Remove from Favorites"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </MenuItem.Style>
                                                <MenuItem.Icon>
                                                    <Path Data="M12,21.35L10.55,20.03C5.4,15.36 2,12.27 2,8.5C2,5.41 4.42,3 7.5,3C9.24,3 10.91,3.81 12,5.08C13.09,3.81 14.76,3 16.5,3C19.58,3 22,5.41 22,8.5C22,12.27 18.6,15.36 13.45,20.03L12,21.35Z"
                                                          Fill="{StaticResource AccentRedBrush}"
                                                          Width="14" Height="14"
                                                          Stretch="Uniform"/>
                                                </MenuItem.Icon>
                                            </MenuItem>
                                            <Separator Background="{StaticResource BorderBrush}"/>
                                            <MenuItem Header="Add to Collection"
                                                      x:Name="AddToCollectionMenu"
                                                      Tag="{Binding}"
                                                      SubmenuOpened="AddToCollectionMenu_SubmenuOpened">
                                                <MenuItem.Icon>
                                                    <Path Data="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"
                                                          Fill="{StaticResource AccentCyanBrush}"
                                                          Width="14" Height="14"
                                                          Stretch="Uniform"/>
                                                </MenuItem.Icon>
                                                <!-- Placeholder - will be populated dynamically -->
                                                <MenuItem Header="Loading..." IsEnabled="False"/>
                                            </MenuItem>
                                            <MenuItem Header="Show in Folder"
                                                      Click="OpenFileLocation_Click"
                                                      Tag="{Binding}">
                                                <MenuItem.Icon>
                                                    <Path Data="M10,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8C22,6.89 21.1,6 20,6H12L10,4Z"
                                                          Fill="{StaticResource TextSecondaryBrush}"
                                                          Width="14" Height="14"
                                                          Stretch="Uniform"/>
                                                </MenuItem.Icon>
                                            </MenuItem>
                                            <Separator Background="{StaticResource BorderBrush}"/>
                                            <MenuItem Header="Delete"
                                                      Click="DeleteModel_Click"
                                                      Tag="{Binding}">
                                                <MenuItem.Icon>
                                                    <Path Data="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"
                                                          Fill="{StaticResource AccentRedBrush}"
                                                          Width="14" Height="14"
                                                          Stretch="Uniform"/>
                                                </MenuItem.Icon>
                                            </MenuItem>
                                        </ContextMenu>
                                    </Border.ContextMenu>
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="160"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>
    
                                        <!-- Thumbnail Placeholder -->
                                        <Border Grid.Row="0" 
                                                Background="{StaticResource BackgroundLightBrush}"
                                                CornerRadius="12,12,0,0">
                                            <Grid>
                                                <!-- Placeholder Icon -->
                                                <Path Data="M12,2L2,7V17L12,22L22,17V7L12,2M12,4.15L18.74,7.5L12,10.85L5.26,7.5L12,4.15Z"
                                                      Fill="{StaticResource TextMutedBrush}"
                                                      Width="48" Height="48"
                                                      Stretch="Uniform"
                                                      HorizontalAlignment="Center"
                                                      VerticalAlignment="Center"
                                                      Opacity="0.3"/>
    
                                                <!-- Thumbnail Image (when available) -->
                                                <Image Source="{Binding ThumbnailPath}"
                                                       Stretch="Uniform"
                                                       Visibility="{Binding ThumbnailGenerated, Converter={StaticResource BoolToVis}}"/>
    
                                                <!-- Selection Checkbox -->
                                                <CheckBox HorizontalAlignment="Left"
                                                         VerticalAlignment="Top"
                                                         Margin="12,12,0,0"
                                                         Click="Checkbox_Click"
                                                         Tag="{Binding}"
                                                         Background="White"
                                                         BorderBrush="{StaticResource AccentCyanBrush}"
                                                         BorderThickness="2"
                                                         Width="20" Height="20"
                                                         Cursor="Hand">
                                                    <CheckBox.Style>
                                                        <Style TargetType="CheckBox">
                                                            <Setter Property="Opacity" Value="0"/>
                                                            <Style.Triggers>
                                                                <Trigger Property="IsChecked" Value="True">
                                                                    <Setter Property="Opacity" Value="1"/>
                                                                </Trigger>
                                                                <DataTrigger Binding="{Binding IsMouseOver, RelativeSource={RelativeSource AncestorType=Border}}" Value="True">
                                                                    <Setter Property="Opacity" Value="1"/>
                                                                </DataTrigger>
                                                                <DataTrigger Binding="{Binding DataContext.IsMultiSelectMode, RelativeSource={RelativeSource AncestorType=ItemsControl}}" Value="True">
                                                                    <Setter Property="Opacity" Value="1"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </CheckBox.Style>
                                                    <CheckBox.IsChecked>
                                                     <MultiBinding Converter="{StaticResource IsSelected}" Mode="OneWay">
                                                         <Binding Path="DataContext.SelectedModels" RelativeSource="{RelativeSource AncestorType=ItemsControl}"/>
                                                         <Binding/>
                                                     </MultiBinding>
                                                    </CheckBox.IsChecked>
                                                 </CheckBox>
    
                                                <!-- File Type Badge -->
                                                <Border Background="{StaticResource BackgroundDarkBrush}"
                                                        CornerRadius="4"
                                                        Padding="8,4"
                                                        HorizontalAlignment="Left"
                                                        VerticalAlignment="Top"
                                                        Margin="12,40,0,0">
                                                    <TextBlock Text="{Binding FileType}"
                                                               FontSize="10"
                                                               FontWeight="Bold"
                                                               Foreground="{StaticResource AccentCyanBrush}"/>
                                                </Border>
    

    
                                                <!-- Favorite Button -->
                                                <Button Style="{StaticResource IconButton}"
                                                        Command="{Binding DataContext.ToggleFavoriteCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                        CommandParameter="{Binding}"
                                                        HorizontalAlignment="Right"
                                                        VerticalAlignment="Top"
                                                        Margin="8">
                                                    <Path Width="16" Height="16" Stretch="Uniform">
                                                        <Path.Style>
                                                            <Style TargetType="Path">
                                                                <Setter Property="Data" Value="M12.1,18.55L12,18.65L11.89,18.55C7.14,14.24 4,11.39 4,8.5C4,6.5 5.5,5 7.5,5C9.04,5 10.54,6 11.07,7.36H12.93C13.46,6 14.96,5 16.5,5C18.5,5 20,6.5 20,8.5C20,11.39 16.86,14.24 12.1,18.55M16.5,3C14.76,3 13.09,3.81 12,5.08C10.91,3.81 9.24,3 7.5,3C4.42,3 2,5.41 2,8.5C2,12.27 5.4,15.36 10.55,20.03L12,21.35L13.45,20.03C18.6,15.36 22,12.27 22,8.5C22,5.41 19.58,3 16.5,3Z"/>
                                                                <Setter Property="Fill" Value="{StaticResource TextMutedBrush}"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding IsFavorite}" Value="True">
                                                                        <Setter Property="Data" Value="M12,21.35L10.55,20.03C5.4,15.36 2,12.27 2,8.5C2,5.41 4.42,3 7.5,3C9.24,3 10.91,3.81 12,5.08C13.09,3.81 14.76,3 16.5,3C19.58,3 22,5.41 22,8.5C22,12.27 18.6,15.36 13.45,20.03L12,21.35Z"/>
                                                                        <Setter Property="Fill" Value="{StaticResource AccentRedBrush}"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Path.Style>
                                                    </Path>
                                                </Button>
    
                                                <!-- Selection Indicator -->
                                                <Border Background="#4039D0D8"
                                                        CornerRadius="12,12,0,0"
                                                        IsHitTestVisible="False">
                                                    <Border.Visibility>
                                                        <MultiBinding Converter="{StaticResource SelectionToVis}">
                                                            <Binding Path="DataContext.SelectedModels" RelativeSource="{RelativeSource AncestorType=ItemsControl}"/>
                                                            <Binding/>
                                                        </MultiBinding>
                                                    </Border.Visibility>
                                                    <Grid>
                                                        <!-- Checkmark Icon -->
                                                        <Border Background="{StaticResource AccentCyanBrush}"
                                                                CornerRadius="12"
                                                                Width="24" Height="24"
                                                                HorizontalAlignment="Center"
                                                                VerticalAlignment="Center">
                                                            <Path Data="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"
                                                                  Fill="White"
                                                                  Width="14" Height="14"
                                                                  Stretch="Uniform"
                                                                  HorizontalAlignment="Center"
                                                                  VerticalAlignment="Center"/>
                                                        </Border>
                                                    </Grid>
                                                </Border>
                                            </Grid>
                                        </Border>
    
                                        <!-- Card Info -->
                                        <StackPanel Grid.Row="1" Margin="16,12,16,16">
                                            <TextBlock Text="{Binding DisplayName}"
                                                       FontWeight="SemiBold"
                                                       FontSize="14"
                                                       TextTrimming="CharacterEllipsis"
                                                       ToolTip="{Binding Name}"/>
    
                                            <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                                                <TextBlock Text="{Binding Category.Name, FallbackValue='Uncategorized'}"
                                                           Style="{StaticResource CaptionText}"
                                                           FontSize="12"/>
                                                <TextBlock Text="•" 
                                                           Foreground="{StaticResource TextMutedBrush}"
                                                           Margin="8,0"/>
                                                <TextBlock Style="{StaticResource CaptionText}" FontSize="12">
                                                    <TextBlock.Text>
                                                        <Binding Path="Gcodes.Count" StringFormat="{}{0} G-codes"/>
                                                    </TextBlock.Text>
                                                </TextBlock>
                                            </StackPanel>
    
                                            <!-- Source URL indicator -->
                                            <StackPanel Orientation="Horizontal" 
                                                        Margin="0,8,0,0"
                                                        Visibility="{Binding SourceUrl, Converter={StaticResource BoolToVis}}">
                                                <Path Data="M10.59,13.41C11,13.8 11,14.44 10.59,14.83C10.2,15.22 9.56,15.22 9.17,14.83C7.22,12.88 7.22,9.71 9.17,7.76V7.76L12.71,4.22C14.66,2.27 17.83,2.27 19.78,4.22C21.73,6.17 21.73,9.34 19.78,11.29L18.29,12.78C18.3,11.96 18.17,11.14 17.89,10.36L18.36,9.88C19.54,8.71 19.54,6.81 18.36,5.64C17.19,4.46 15.29,4.46 14.12,5.64L10.59,9.17C9.41,10.34 9.41,12.24 10.59,13.41M13.41,9.17C13.8,8.78 14.44,8.78 14.83,9.17C16.78,11.12 16.78,14.29 14.83,16.24V16.24L11.29,19.78C9.34,21.73 6.17,21.73 4.22,19.78C2.27,17.83 2.27,14.66 4.22,12.71L5.71,11.22C5.7,12.04 5.83,12.86 6.11,13.65L5.64,14.12C4.46,15.29 4.46,17.19 5.64,18.36C6.81,19.54 8.71,19.54 9.88,18.36L13.41,14.83C14.59,13.66 14.59,11.76 13.41,10.59C13,10.2 13,9.56 13.41,9.17Z"
                                                      Fill="{StaticResource AccentBlueBrush}"
                                                      Width="12" Height="12"
                                                      Stretch="Uniform"
                                                      Margin="0,0,6,0"
                                                      Opacity="0.8"/>
                                                <TextBlock Text="Has source URL"
                                                           Style="{StaticResource CaptionText}"
                                                           FontSize="11"
                                                           Foreground="{StaticResource AccentBlueBrush}"
                                                           Opacity="0.8"/>
                                            </StackPanel>
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>

                <!-- Empty State -->
                <Grid>
                    <Grid.Style>
                        <Style TargetType="Grid">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Models.Count}" Value="0">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Grid.Style>
                    <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Opacity="0.5">
                        <Path Data="M12,2L2,7V17L12,22L22,17V7L12,2M12,4.15L18.74,7.5L12,10.85L5.26,7.5L12,4.15M4,9.31L11,13.04V19.93L4,16.2V9.31M20,9.31V16.2L13,19.93V13.04L20,9.31Z"
                              Fill="{StaticResource TextMutedBrush}"
                              Width="80" Height="80"
                              Stretch="Uniform"
                              HorizontalAlignment="Center"
                              Margin="0,0,0,24"/>
                        <TextBlock Text="No Models Found"
                                   Style="{StaticResource SubHeaderText}"
                                   HorizontalAlignment="Center"
                                   Foreground="{StaticResource TextMutedBrush}"/>
                        <TextBlock Text="Import .stl, .3mf, or .gcode files to get started"
                                   Style="{StaticResource CaptionText}"
                                   HorizontalAlignment="Center"
                                   Margin="0,8,0,0"/>
                        <Button Style="{StaticResource PrimaryButton}"
                                Command="{Binding ImportFilesManuallyCommand}"
                                Content="Import Files"
                                HorizontalAlignment="Center"
                                Margin="0,24,0,0"/>
                    </StackPanel>
                </Grid>

            <!-- Floating Action Bar -->
            <Border Grid.Row="2" 
                    Style="{StaticResource FloatingActionBar}"
                    HorizontalAlignment="Center" 
                    VerticalAlignment="Bottom" 
                    Margin="0,0,0,32"
                    Visibility="{Binding HasSelection, Converter={StaticResource BoolToVis}}">
                <StackPanel Orientation="Horizontal">
                    <!-- Selection Count -->
                    <TextBlock VerticalAlignment="Center" 
                               Margin="16,0"
                               FontWeight="SemiBold"
                               Foreground="{StaticResource TextPrimaryBrush}">
                        <Run Text="{Binding SelectedCount, Mode=OneWay}"/>
                        <Run Text="Selected"/>
                    </TextBlock>
                    
                    <Separator Width="1" Height="24" Background="{StaticResource BorderBrush}" Margin="0,0,8,0"/>

                    <!-- Actions -->
                    <Button Style="{StaticResource FabButton}" Command="{Binding SelectAllCommand}" ToolTip="Select All">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="M19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M10,17L5,12L6.41,10.59L10,14.17L17.59,6.58L19,8L10,17Z"
                                  Fill="{StaticResource TextPrimaryBrush}" Width="16" Height="16" Stretch="Uniform" Margin="0,0,8,0"/>
                            <TextBlock Text="All"/>
                        </StackPanel>
                    </Button>

                    <Button Style="{StaticResource FabButton}" Click="BulkAddTags_Click" ToolTip="Add Tags">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="M5.5,7A1.5,1.5 0 0,1 4,5.5A1.5,1.5 0 0,1 5.5,4A1.5,1.5 0 0,1 7,5.5A1.5,1.5 0 0,1 5.5,7M21.41,11.58L12.41,2.58C12.05,2.22 11.55,2 11,2H4C2.89,2 2,2.89 2,4V11C2,11.55 2.22,12.05 2.59,12.41L11.58,21.41C11.95,21.77 12.45,22 13,22C13.55,22 14.05,21.77 14.41,21.41L21.41,14.41C21.78,14.05 22,13.55 22,13C22,12.44 21.77,11.94 21.41,11.58Z"
                                  Fill="{StaticResource TextPrimaryBrush}" Width="16" Height="16" Stretch="Uniform" Margin="0,0,8,0"/>
                            <TextBlock Text="Tags"/>
                        </StackPanel>
                    </Button>

                    <Button Style="{StaticResource FabButton}" 
                            x:Name="BulkAddToCollectionButton"
                            Click="BulkAddToCollection_Click" 
                            ToolTip="Add to Collection">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="M3,3H21V21H3V3M5,5V19H19V5H5M7,7H11V11H7V7M13,7H17V11H13V7M7,13H11V17H7V13M13,13H17V17H13V13Z"
                                  Fill="{StaticResource AccentCyanBrush}" Width="16" Height="16" Stretch="Uniform" Margin="0,0,8,0"/>
                            <TextBlock Text="Collection" Foreground="{StaticResource AccentCyanBrush}"/>
                        </StackPanel>
                    </Button>

                    <Button Style="{StaticResource FabButton}" Command="{Binding RegenerateThumbnailsCommand}" ToolTip="Regenerate Thumbnails">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="M4,4H7L9,2H15L17,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9Z"
                                  Fill="{StaticResource TextPrimaryBrush}" Width="16" Height="16" Stretch="Uniform" Margin="0,0,8,0"/>
                            <TextBlock Text="Thumbnails"/>
                        </StackPanel>
                    </Button>

                    <Button Style="{StaticResource FabButton}" 
                            Click="BulkRemoveFromCollection_Click" 
                            ToolTip="Remove from Collection"
                            Visibility="{Binding SelectedCollection, Converter={StaticResource NullToVisConverter}}">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="M19,13H5V11H19V13Z"
                                  Fill="{StaticResource AccentRedBrush}" Width="16" Height="16" Stretch="Uniform" Margin="0,0,8,0"/>
                            <TextBlock Text="Remove" Foreground="{StaticResource AccentRedBrush}"/>
                        </StackPanel>
                    </Button>

                    <Button Style="{StaticResource FabPrimaryButton}" Command="{Binding BulkDeleteCommand}" Background="#E53935" ToolTip="Delete Selected">
                         <StackPanel Orientation="Horizontal">
                            <Path Data="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"
                                  Fill="White" Width="16" Height="16" Stretch="Uniform" Margin="0,0,8,0"/>
                            <TextBlock Text="Delete" Foreground="White"/>
                        </StackPanel>
                    </Button>

                    <Separator Width="1" Height="24" Background="{StaticResource BorderBrush}" Margin="8,0"/>

                    <Button Style="{StaticResource IconButton}" Command="{Binding ClearSelectionCommand}" ToolTip="Clear Selection">
                        <Path Data="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"
                              Fill="{StaticResource TextSecondaryBrush}" Width="16" Height="16" Stretch="Uniform"/>
                    </Button>
                </StackPanel>
            </Border>
            </Grid>

            <!-- Status Bar -->
            <Border Grid.Row="3" 
                    Background="{StaticResource BackgroundMediumBrush}"
                    BorderBrush="{StaticResource BorderBrush}"
                    BorderThickness="0,1,0,0"
                    Padding="20,12">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0" Orientation="Horizontal">
                        <!-- Watcher Status -->
                        <Ellipse Width="8" Height="8" Margin="0,0,6,0">
                            <Ellipse.Style>
                                <Style TargetType="Ellipse">
                                    <Setter Property="Fill" Value="{StaticResource AccentRedBrush}"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsWatcherRunning}" Value="True">
                                            <Setter Property="Fill" Value="{StaticResource AccentGreenBrush}"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Ellipse.Style>
                        </Ellipse>
                        <TextBlock Text="{Binding StatusMessage}"
                                   Style="{StaticResource CaptionText}"
                                   Margin="0,0,20,0"/>

                        <!-- Python Status -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,20,0">
                            <TextBlock Text="🐍" Margin="0,0,4,0" FontSize="12"/>
                            <TextBlock>
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock" BasedOn="{StaticResource CaptionText}">
                                        <Setter Property="Text" Value="Python ✗"/>
                                        <Setter Property="Foreground" Value="{StaticResource AccentRedBrush}"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsPythonAvailable}" Value="True">
                                                <Setter Property="Text" Value="Python ✓"/>
                                                <Setter Property="Foreground" Value="{StaticResource AccentGreenBrush}"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                        </StackPanel>

                        <!-- Thumbnail Queue -->
                        <StackPanel Orientation="Horizontal" 
                                    Visibility="{Binding ThumbnailQueueCount, Converter={StaticResource BoolToVis}}">
                            <TextBlock Text="📷" Margin="0,0,4,0" FontSize="12"/>
                            <TextBlock Style="{StaticResource CaptionText}"
                                       Foreground="{StaticResource AccentOrangeBrush}">
                                <Run Text="{Binding ThumbnailQueueCount, Mode=OneWay}"/>
                                <Run Text="in queue"/>
                            </TextBlock>
                        </StackPanel>
                    </StackPanel>

                    <!-- Pagination Controls -->
                    <StackPanel Grid.Column="1" 
                                Orientation="Horizontal" 
                                Margin="0,0,20,0"
                                VerticalAlignment="Center">
                        <TextBlock Style="{StaticResource CaptionText}"
                                   VerticalAlignment="Center"
                                   Margin="0,0,12,0"
                                   Foreground="{StaticResource TextSecondaryBrush}">
                            <Run Text="{Binding TotalModels, Mode=OneWay}" FontWeight="SemiBold" Foreground="{StaticResource AccentCyanBrush}"/>
                            <Run Text="model"/>
                        </TextBlock>
                        
                        <Button Style="{StaticResource IconButton}"
                                Command="{Binding PreviousPageCommand}"
                                IsEnabled="{Binding HasPreviousPage}"
                                ToolTip="Previous page"
                                Padding="8,4"
                                MinWidth="32">
                            <Path Data="M15.41,16.58L10.83,12L15.41,7.41L14,6L8,12L14,18L15.41,16.58Z"
                                  Fill="{StaticResource TextSecondaryBrush}"
                                  Width="16" Height="16"
                                  Stretch="Uniform"/>
                        </Button>

                        <StackPanel Orientation="Horizontal" Margin="8,0">
                            <TextBlock Style="{StaticResource CaptionText}"
                                       VerticalAlignment="Center"
                                       FontWeight="SemiBold">
                                <Run Text="{Binding CurrentPage, Mode=OneWay}" Foreground="{StaticResource AccentCyanBrush}"/>
                                <Run Text="/"/>
                                <Run Text="{Binding TotalPages, Mode=OneWay}"/>
                            </TextBlock>
                        </StackPanel>

                        <Button Style="{StaticResource IconButton}"
                                Command="{Binding NextPageCommand}"
                                IsEnabled="{Binding HasNextPage}"
                                ToolTip="Next page"
                                Padding="8,4"
                                MinWidth="32">
                            <Path Data="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"
                                  Fill="{StaticResource TextSecondaryBrush}"
                                  Width="16" Height="16"
                                  Stretch="Uniform"/>
                        </Button>
                    </StackPanel>

                    <TextBlock Grid.Column="2" 
                               Text="PrintVault 3D v1.0.0"
                               Style="{StaticResource CaptionText}"
                               Opacity="0.6"/>
                </Grid>
            </Border>

            <!-- Skeleton Loading Overlay -->
            <Border Grid.RowSpan="4"
                    Background="{StaticResource BackgroundDarkBrush}"
                    Visibility="{Binding IsBusy, Converter={StaticResource BoolToVis}}"
                    Panel.ZIndex="1000"
                    IsHitTestVisible="True">
                <Grid>
                    <!-- Loading Text/Status -->
                    <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Panel.ZIndex="10">
                        <TextBlock Text="LOADING LIBRARY" 
                                   Style="{StaticResource HeaderText}"
                                   Foreground="{StaticResource AccentCyanBrush}"
                                   HorizontalAlignment="Center"
                                   FontSize="24"
                                   Opacity="0.8"/>
                        <TextBlock Text="Please wait while we scan your models..." 
                                   Style="{StaticResource CaptionText}"
                                   HorizontalAlignment="Center"
                                   Margin="0,8,0,0"/>
                    </StackPanel>

                    <!-- Skeleton Cards (Visual Filler) -->
                    <ScrollViewer VerticalScrollBarVisibility="Hidden" HorizontalScrollBarVisibility="Disabled">
                         <WrapPanel HorizontalAlignment="Center" Margin="24">
                            <!-- Dummy items to simulate loaded content -->
                            <Border Style="{StaticResource SkeletonLoader}" Width="240" Height="280" Margin="8"/>
                            <Border Style="{StaticResource SkeletonLoader}" Width="240" Height="280" Margin="8"/>
                            <Border Style="{StaticResource SkeletonLoader}" Width="240" Height="280" Margin="8"/>
                            <Border Style="{StaticResource SkeletonLoader}" Width="240" Height="280" Margin="8"/>
                            <Border Style="{StaticResource SkeletonLoader}" Width="240" Height="280" Margin="8"/>
                            <Border Style="{StaticResource SkeletonLoader}" Width="240" Height="280" Margin="8"/>
                            <Border Style="{StaticResource SkeletonLoader}" Width="240" Height="280" Margin="8"/>
                            <Border Style="{StaticResource SkeletonLoader}" Width="240" Height="280" Margin="8"/>
                            <Border Style="{StaticResource SkeletonLoader}" Width="240" Height="280" Margin="8"/>
                            <Border Style="{StaticResource SkeletonLoader}" Width="240" Height="280" Margin="8"/>
                            <Border Style="{StaticResource SkeletonLoader}" Width="240" Height="280" Margin="8"/>
                            <Border Style="{StaticResource SkeletonLoader}" Width="240" Height="280" Margin="8"/>
                            <Border Style="{StaticResource SkeletonLoader}" Width="240" Height="280" Margin="8"/>
                            <Border Style="{StaticResource SkeletonLoader}" Width="240" Height="280" Margin="8"/>
                            <Border Style="{StaticResource SkeletonLoader}" Width="240" Height="280" Margin="8"/>
                        </WrapPanel>
                    </ScrollViewer>
                </Grid>
            </Border>

            <!-- Drag & Drop Overlay -->
            <Grid Grid.RowSpan="4" 
                  Background="#E60D1117"
                  Visibility="{Binding IsDragOver, RelativeSource={RelativeSource AncestorType=Window}, Converter={StaticResource BoolToVis}}">
                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                    <Border BorderBrush="{StaticResource AccentCyanBrush}" 
                            BorderThickness="2" 
                            CornerRadius="20"
                            Padding="60">
                        <StackPanel>
                            <Path Data="M19.35,10.04C18.67,6.59 15.64,4 12,4C9.11,4 6.6,5.64 5.35,8.04C2.34,8.36 0,10.91 0,14A6,6 0 0,0 6,20H19A5,5 0 0,0 24,15C24,12.36 21.95,10.22 19.35,10.04M14,13V17H10V13H7L12,8L17,13H14Z"
                                  Fill="{StaticResource AccentCyanBrush}"
                                  Width="80" Height="80"
                                  Stretch="Uniform"
                                  HorizontalAlignment="Center"
                                  Margin="0,0,0,24"/>
                            <TextBlock Text="Drop Files Here" 
                                       Style="{StaticResource HeaderText}"
                                       Foreground="{StaticResource AccentCyanBrush}"
                                       HorizontalAlignment="Center"/>
                            <TextBlock Text="Import STL, 3MF, or G-code files" 
                                       Style="{StaticResource SubHeaderText}"
                                       Opacity="0.8"
                                       HorizontalAlignment="Center"
                                       Margin="0,8,0,0"/>
                        </StackPanel>
                    </Border>
                </StackPanel>
            </Grid>

        </Grid>
    </Grid>
    </Grid>
</Window>


